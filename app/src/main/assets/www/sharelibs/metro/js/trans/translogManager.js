!function(){var t=function(t,n){var e=this;this.TranslogException=function(t){return console.log("[TranslogException]:"+t),new Error(this.message=t)};var i=this.TranslogException,a="t_sno_cfg",s="t_trans_log",o="t_properties",u="voucher",r=!1,l=[],c=(n.AndFilter,n.PropertyFilter);n.OrFileter;this.init=function(){this.tableSchemas=n.defineTables([{name:o,schema:{key:"TEXT",value:"TEXT",cre_time:"DATE",upd_time:"DATE"}},{name:a,schema:{type:"TEXT",value:"INT",max_value:"INT",cre_time:"DATE",upd_time:"DATE"}},{name:s,schema:{merchant_no:"TEXT",terminal_no:"TEXT",batch_no:"TEXT",voucher_no:"TEXT",orgin_voucher_no:"TEXT",ref_no:"TEXT",orgin_ref_no:"TEXT",pay_amt:"INT",settle_amt:"INT",currency:"TEXT",channel:"TEXT",trans_type:"TEXT",trans_state:"INT",trans_time:"DATE",is_upload_needed:"BOOL",upload_state:"INT",is_batch_upload:"BOOL",could_be_canceled:"BOOL",settle_time:"DATE",entity:"JSON",cre_time:"DATE",upd_time:"DATE"}}]),e.tableSchemas[a].index(["type"],{unique:!0}),e.tableSchemas[s].index(["merchant_no","terminal_no","batch_no","voucher_no","channel"],{unique:!0}),n.schemaSync(new function(){if(console.log("tables of translog create finished!"),!r){r=!0;for(var n;!t.isNull(n=l.pop());)t.isFunction(n)&&n()}})},this.readyThenDo=function(t){r?t():l.push(t)};var f=this.readyThenDo,_=function(t){f(function(){e.tableSchemas[a];"undefined"!=typeof t&&n.inTransaction(function(){})})},d=function(i,s,o){f(function(){var u=e.tableSchemas[a];"undefined"!=typeof s&&n.inTransaction(function(){var e=function(e){if(t.isNull(e))"undefined"==typeof o&&(o=999999999),e=new u({type:s,value:1,max_value:o,cre_time:new Date}),n.saveOrUpdate(e,function(){i(1)});else{var a=e.value;e.value++,e.value>e.max_value&&(e.value=1),n.saveOrUpdate(e,function(){i(a)})}};u.findBy("type",s,e)})})},h=function(i,s,o){f(function(){var u=e.tableSchemas[a];"undefined"!=typeof i&&n.inTransaction(function(){var e=function(e){t.isNull(e)?("undefined"==typeof o&&(o=999999999),e=new u({type:i,value:s,max_value:o,cre_time:new Date}),n.saveOrUpdate(e)):(e.value=s+"",n.saveOrUpdate(e))};u.findBy("type",i,e)})})},E=function(){return e.tableSchemas[s]};this.ChannelType={cups:"CUPS"},this.UploadStatus={NOT_DEAL:0,SUCCESS:1,FAILED:2,FAILED_REACHED_LIMIT:3};var S=this.UploadStatus;this.TransferStatus={NEW:0,SEND_TO_ACQUIRER:1,SUCCESS:2,PARTICAL_SUCCESS:3,FAILED:4,FAILED_AND_WAITING_REVERSAL:5,REVERSAL_SUCCESS:6,CANCELED:7,SETTLED:8,REVERSAL_FAILED:9},this.getVoucherNo=function(n){d(function(e){n(t.isoutils.paddingLeft(e.toString(),6,"0"))},u,999999)},this.setVoucherNo=function(t){h(u,t,999999)},this.resetVoucherNo=function(){_(u)},this.getFlowNo=function(t,n,e){d(function(e){n(t)},t,e)},this.resetFlowNo=function(t){_(t)},this.setFlowNo=function(t,n,e){h(t,n,e)};var T=e.TransferStatus;this.sendToAcquirer=function(e,a){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.NEW)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);e.trans_state=T.SEND_TO_ACQUIRER,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(a)&&t.isFunction(a)&&a(n)})})})},this.doFail=function(e,a,s){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.NEW&&e.trans_state!==T.SEND_TO_ACQUIRER)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);a?e.trans_state=T.FAILED_AND_WAITING_REVERSAL:e.trans_state=T.FAILED,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(s)&&t.isFunction(s)&&s(n)})})})},this.doReversal=function(e,a,s){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.FAILED_AND_WAITING_REVERSAL&&e.trans_state!==T.SEND_TO_ACQUIRER)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);a?e.trans_state=T.REVERSAL_SUCCESS:e.trans_state=T.REVERSAL_FAILED,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(s)&&t.isFunction(s)&&s(n)})})})},this.doSuccess=function(e,a,s){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.NEW&&e.trans_state!==T.SEND_TO_ACQUIRER)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);a?e.trans_state=T.PARTICAL_SUCCESS:e.trans_state=T.SUCCESS,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(s)&&t.isFunction(s)&&s(n)})})})},this.doCancel=function(e,a){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.SUCCESS&&e.trans_state!==T.PARTICAL_SUCCESS)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);if(!e.could_be_canceled)throw new i("该交易无法被撤销！");e.trans_state=T.CANCELED,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(a)&&t.isFunction(a)&&a(n)})})})},this.doSettle=function(e,a){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);if(e.trans_state!==T.SUCCESS&&e.trans_state!==T.PARTICAL_SUCCESS)throw new i("非法的流水状态："+e.voucher_no+",state:"+e.trans_state);e.trans_state=T.SETTLED,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){t.isNull(a)||a(n)})})})},this.doSettleOffline=function(e,a){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);e.trans_state=T.SETTLED,e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){t.isNull(a)||a(n)})})})},this.doUpload=function(e,a,s){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);e.is_upload_needed||console.log("非上传类型的交易..."),console.log("更新前上传状态为："+e.upload_state),e.upload_state=a,console.log("更新后上传状态为："+e.upload_state),e.upd_time=new Date,e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){t.isNull(s)||s(n)})})})},this.getNeedToSyncs=function(n,a,o){f(function(){if(t.isNull(n)&&"string"!=typeof n)throw new i("通道标示不可为空！或类型不符合！"+n);var u=e.tableSchemas[s],r=u.all().filter("channel","=",n);t.isNull(a)||(r=r.and(new c("batch_no","=",a))),r=r.and(new c("trans_state","in",[T.FAILED_AND_WAITING_REVERSAL,T.SEND_TO_ACQUIRER])),r.list(function(t){o(t)})})},this.removeAll=function(n,a,o){f(function(){if(t.isNull(n)&&"string"!=typeof n)throw new i("通道标示不可为空！或类型不符合！"+n);var u=e.tableSchemas[s],r=u.all().filter("channel","=",n);t.isNull(a)||(r=r.and(new c("batch_no","=",a))),r.destroyAll(function(){o()})})},this.getToSettles=function(n,a,o){f(function(){if(t.isNull(n)&&"string"!=typeof n)throw new i("通道标示不可为空！或类型不符合！"+n);var u=e.tableSchemas[s],r=u.all().filter("channel","=",n);t.isNull(a)||(r=r.and(new c("batch_no","=",a))),r=r.and(new c("trans_state","in",[T.SUCCESS,T.PARTICAL_SUCCESS,T.CANCELED])),r.list(function(t){o(t)})})},this.getNeedToUploads=function(n,a,o,u){f(function(){if(t.isNull(n)&&"string"!=typeof n)throw new i("通道标示不可为空！或类型不符合！"+n);var r=e.tableSchemas[s],l=r.all().filter("channel","=",n);t.isNull(a)||(l=l.and(new c("batch_no","=",a))),l=t.isNull(u)?l.and(new c("trans_state","in",[T.SUCCESS,T.PARTICAL_SUCCESS])):l.and(new c("trans_state","in",u)),l=l.and(new c("is_upload_needed","=",(!0))),l=l.and(new c("upload_state","in",[S.NOT_DEAL,S.FAILED])),l.list(function(t){o(t)})})},this.getTranslog=function(n,a,o,u){f(function(){if(t.isNull(n)&&"string"!=typeof n)throw new i("通道标示不可为空！或类型不符合！"+n);if(t.isNull(o)&&"string"!=typeof o)throw new i("流水号不可为空！或流水号类型不符合！"+o);var r=e.tableSchemas[s],l=r.all().filter("channel","=",n);t.isNull(a)||(l=l.and(new c("batch_no","=",a))),l=l.and(new c("voucher_no","=",o)),l.list(function(n){u(t.isNull(n)?null:n[0])})})},this.removeTranslog=function(t,e){f(function(){n.remove(t,e)})},this.newTransLog=function(a,o,u,r){f(function(){if(t.isNull(u))throw new i("流水号(voucher_no)不可为空！");var l={channel:a,batch_no:o,voucher_no:u,trans_state:T.NEW,is_batch_upload:!1,upload_state:S.NOT_DEAL,is_batch_upload:!1,could_be_canceled:!0,entity:{},cre_time:new Date};l=new e.tableSchemas[s](l),n.saveOrUpdate(l,function(){E().findBy("id",l.id,function(n){!t.isNull(r)&&t.isFunction(r)&&r(n)})})})},this.saveTransLog=function(e,a){f(function(){if(t.isNull(e))throw new i("交易实体不可为空！"+e);e.markDirty("entity"),n.saveOrUpdate(e,function(){E().findBy("id",e.id,function(n){!t.isNull(a)&&t.isFunction(a)&&a(n)})})})},this.PROKEY_CONST={PROKEY_PROCESSINGCOMMAND_CODE:"PROCESSINGCOMMAND_CODE",PROKEY_SIGNUP_DATE:"SIGNUP_DATE",PROKEY_BATCH_ID:"BATCH_ID"},this.setProperty=function(i,a){var s=e.tableSchemas[o];s.findBy("key",i,function(e){t.isNull(e)?(e=new s({key:i,value:a,cre_time:new Date}),n.saveOrUpdate(e)):(e.value=a,n.saveOrUpdate(e))})},this.removeProperty=function(i){var a=e.tableSchemas[o];a.findBy("key",i,function(e){t.isNull(e)||n.remove(e)})},this.getProperty=function(n,i){var a=e.tableSchemas[o];a.findBy("key",n,function(n){i(t.isNull(n)?null:n.value)})}};define(["utils","dbManager"],function(n,e){return new t(n,e)})}();