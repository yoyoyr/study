function initPersistence(t){if(t.isImmutable)return t;t.isImmutable=function(t){return"id"==t},t.defineProp=function(t,e,n,i){"function"==typeof t.__defineSetter__&&"function"==typeof t.__defineGetter__?(t.__defineSetter__(e,function(t){n(t)}),t.__defineGetter__(e,function(){return i()})):Object.defineProperty(t,e,{get:i,set:function(t){n(t)},enumerable:!0,configurable:!0})},t.set=function(e,n,i){if(t.isImmutable(n))throw new Error("immutable field: "+n);e[n]=i},t.get=function(t,e){return 1==arguments.length?t:t[e]},function(){function n(t){return _[t]}function i(t){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=t}function r(i){function o(n,r,o){var s=e.getArgs(arguments,[{name:"session",optional:!0,check:t.isSession,defaultValue:t},{name:"obj",optional:!0,check:function(t){return t},defaultValue:{}}]);if(l.isMixin)throw new Error("Cannot instantiate mixin");n=s.session,r=s.obj;var c=this;this.id=r.id||t.createUUID(),this._new=!0,this._type=i,this._dirtyProperties={},this._data={},this._data_obj={},this._session=n||t,this.subscribers={};for(var u in l.fields)!function(){if(l.fields.hasOwnProperty(u)){var e=u;t.defineProp(c,e,function(t){var i=c._data[e];(i!==t||i&&t&&i.getTime&&t.getTime)&&(c._data[e]=t,c._dirtyProperties[e]=i,c.triggerEvent("set",c,e,t),c.triggerEvent("change",c,e,t),n.propertyChanged(c,e,i,t))},function(){return c._data[e]}),c._data[u]=a(l.fields[u])}}();for(var h in l.hasOne)l.hasOne.hasOwnProperty(h)&&!function(){var e=h,i=l.hasOne[h].type.meta.isMixin?e+"_class":null;t.defineProp(c,e,function(t){var r=c._data[e],o=c._data_obj[e]||n.trackedObjects[c._data[e]];if(null==t?(c._data[e]=null,c._data_obj[e]=void 0,i&&(c[i]="")):t.id?(c._data[e]=t.id,c._data_obj[e]=t,i&&(c[i]=t._type),n.add(t),n.add(c)):c._data[e]=t,c._dirtyProperties[e]=r,c.triggerEvent("set",c,e,t),c.triggerEvent("change",c,e,t),l.hasOne[e].inverseProperty){var a=c[e];if(a){var s=a[l.hasOne[e].inverseProperty];s.list&&s._filter&&s.triggerEvent("change",c,e,t)}if(o){var s=o[l.hasOne[e].inverseProperty];s.list&&s._filter&&s.triggerEvent("change",c,e,t)}}},function(){if(c._data[e]){if(void 0!==c._data_obj[e])return c._data_obj[e];if(c._data[e]&&n.trackedObjects[c._data[e]])return c._data_obj[e]=n.trackedObjects[c._data[e]],c._data_obj[e];throw new Error("Property '"+e+"' of '"+l.name+"' with id: "+c._data[e]+" not fetched, either prefetch it or fetch it manually.")}return null})}();for(var h in l.hasMany)l.hasMany.hasOwnProperty(h)&&!function(){var e=h;l.hasMany[e].manyToMany?t.defineProp(c,e,function(n){if(!n||!n._items)throw new Error("Not yet supported.");for(var i=n._items,r=0;r<i.length;r++)t.get(c,e).add(i[r])},function(){if(c._data[e])return c._data[e];var i=l.hasMany[e],r=i.type.meta,o=r.hasMany[i.inverseProperty],a=i.mixin?i.mixin.meta.name:l.name,s=o.mixin?o.mixin.meta.name:r.name,u=new t.ManyToManyDbQueryCollection(n,r.name);return u.initManyToMany(c,e),u._manyToManyFetch={table:i.tableName,prop:a+"_"+e,inverseProp:s+"_"+i.inverseProperty,id:c.id},c._data[e]=u,n.uniqueQueryCollection(u)}):t.defineProp(c,e,function(n){if(!n||!n._items)throw new Error("Not yet supported.");for(var i=n._items,r=0;r<i.length;r++)t.get(c,e).add(i[r])},function(){if(c._data[e])return c._data[e];var i=n.uniqueQueryCollection(new t.DbQueryCollection(n,l.hasMany[e].type.meta.name).filter(l.hasMany[e].inverseProperty,"=",c));return c._data[e]=i,i})}();this.initialize&&this.initialize();for(var p in r)r.hasOwnProperty(p)&&"id"!==p&&t.set(c,p,r[p])}function s(e,i,r,o){var a=(e._session,[]),l=n(e._type),c=l.fields;for(var u in r)r.hasOwnProperty(u)&&a.push(u);var h=[],p=[];a.forEach(function(t){r[t]!==!0||l.hasMany[t]?p.push(t):h.push(t)});var f=e._data,d={};h.forEach(function(n){"id"===n?d.id=e.id:l.hasOne[n]?d[n]=f[n]?{id:f[n]}:null:d[n]=t.entityValToJson(f[n],c[n])}),a=p.slice(),t.asyncForEach(a,function(n,o){l.hasOne[n]?e.fetch(i,n,function(t){t?s(t,i,r[n],function(t){d[n]=t,o()}):(d[n]=null,o())}):l.hasMany[n]&&t.get(e,n).list(function(e){d[n]=[],t.asyncForEach(e,function(t,o){var t=e.pop();r[n]===!0?(d[n].push({id:t.id}),o()):s(t,i,r[n],function(t){d[n].push(t),o()})},o)})},function(){o(d)})}if(T[i])return T[i];var l=_[i];o.prototype=new u,o.meta=l,o.prototype.equals=function(t){return this.id==t.id},o.prototype.toJSON=function(){var t={id:this.id};for(var e in this._data)this._data.hasOwnProperty(e)&&("object"==typeof this._data[e]&&null!=this._data[e]?void 0!=this._data[e].toJSON&&(t[e]=this._data[e].toJSON()):t[e]=this._data[e]);return t},o.prototype.selectJSON=function(n,i,r){var o=this,a=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);if(n=a.tx,i=a.props,r=a.callback,!n)return void this._session.transaction(function(t){o.selectJSON(t,i,r)});var c={};i.forEach(function(t){for(var e=c,n=t.split("."),i=0;i<n.length;i++){var r=n[i];if(i===n.length-1)if("*"===r){e.id=!0;for(var o in l.fields)l.fields.hasOwnProperty(o)&&(e[o]=!0);for(var o in l.hasOne)l.hasOne.hasOwnProperty(o)&&(e[o]=!0);for(var o in l.hasMany)l.hasMany.hasOwnProperty(o)&&(e[o]=!0)}else if("["===r[0]){r=r.substring(1,r.length-1);var a=r.split(/,\s*/);a.forEach(function(t){e[t]=!0})}else e[r]=!0;else e[r]=e[r]||{},e=e[r]}}),s(this,n,c,r)},o.prototype.fetch=function(n,i,o){var a=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:e.hasType("string")},{name:"callback",optional:!1,check:e.isCallback()}]);n=a.tx,i=a.rel,o=a.callback;var s=this,c=this._session;if(!n)return void c.transaction(function(t){s.fetch(t,i,o)});if(this._data[i])if(this._data_obj[i])o&&o(this._data_obj[i]);else{var u=l.hasOne[i].type;u.meta.isMixin&&(u=r(this._data[i+"_class"])),u.load(c,n,this._data[i],function(t){s._data_obj[i]=t,o&&o(t)})}else o&&o(null)},o.prototype.markDirty=function(t){this._dirtyProperties[t]=!0},o.all=function(n){var r=e.getArgs(arguments,[{name:"session",optional:!0,check:t.isSession,defaultValue:t}]);return n=r.session,n.uniqueQueryCollection(new m(n,i))},o.fromSelectJSON=function(n,i,r,a){function s(e){e||(e=new o(n),r.id&&(e.id=r.id)),n.add(e);var s=[];for(var c in r)if(r.hasOwnProperty(c)){if("id"===c)continue;l.fields[c]?t.set(e,c,t.jsonToEntityVal(r[c],l.fields[c])):(l.hasOne[c]||l.hasMany[c])&&s.push(c)}t.asyncForEach(s,function(o,a){if(l.hasOne[o])l.hasOne[o].type.fromSelectJSON(n,i,r[o],function(n){t.set(e,o,n),a()});else if(l.hasMany[o]){var s=t.get(e,o),c=r[o].slice(0),u=l.hasMany[o].type;s.list(i,function(e){t.asyncForEach(c,function(t,r){u.fromSelectJSON(n,i,t,function(t){for(var n=0;n<e.length;n++)if(e[n].id===t.id)return void r();s.add(t),r()})},function(){a()})})}},function(){a(e)})}var c=e.getArgs(arguments,[{name:"session",optional:!0,check:t.isSession,defaultValue:t},{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:e.isCallback()}]);return n=c.session,i=c.tx,r=c.jsonObj,a=c.callback,i?("string"==typeof r&&(r=JSON.parse(r)),r?void(r.id?o.load(n,i,r.id,s):s(new o(n))):void a(null)):void n.transaction(function(t){o.fromSelectJSON(n,t,r,a)})},o.load=function(n,i,r,a){var s=e.getArgs(arguments,[{name:"session",optional:!0,check:t.isSession,defaultValue:t},{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"id",optional:!1,check:e.hasType("string")},{name:"callback",optional:!0,check:e.isCallback(),defaultValue:function(){}}]);o.findBy(s.session,s.tx,"id",s.id,s.callback)},o.findBy=function(n,i,r,a,s){var l=e.getArgs(arguments,[{name:"session",optional:!0,check:t.isSession,defaultValue:t},{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"property",optional:!1,check:e.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:e.isCallback(),defaultValue:function(){}}]);return n=l.session,i=l.tx,r=l.property,a=l.value,s=l.callback,"id"===r&&a in n.trackedObjects?void s(n.trackedObjects[a]):i?void o.all(n).filter(r,"=",a).one(i,function(t){s(t)}):void n.transaction(function(t){o.findBy(n,t,r,a,s)})},o.index=function(t,e){var n=e||{};"string"==typeof t&&(t=[t]),n.columns=t,l.indexes.push(n)},o.hasMany=function(e,n,i){var r=n.meta;if(r.hasMany[i]){var a=l.name+"_"+e+"_"+r.name,s=r.name+"_"+i+"_"+l.name;a>s&&(a=s),l.hasMany[e]={type:n,inverseProperty:i,manyToMany:!0,tableName:a},r.hasMany[i]={type:o,inverseProperty:e,manyToMany:!0,tableName:a},delete l.hasOne[e],delete l.fields[e+"_class"]}else l.hasMany[e]={type:n,inverseProperty:i},r.hasOne[i]={type:o,inverseProperty:e},l.isMixin&&(r.fields[i+"_class"]=t.typeMapper?t.typeMapper.classNameType:"TEXT")},o.hasOne=function(e,n,i){l.hasOne[e]={type:n,inverseProperty:i},n.meta.isMixin&&(l.fields[e+"_class"]=t.typeMapper?t.typeMapper.classNameType:"TEXT")},o.is=function(t){var e=t.meta;if(!e.isMixin)throw new Error("not a mixin: "+t);t.meta.mixedIns=t.meta.mixedIns||[],t.meta.mixedIns.push(l);for(var n in e.fields)e.fields.hasOwnProperty(n)&&(l.fields[n]=e.fields[n]);for(var i in e.hasOne)e.hasOne.hasOwnProperty(i)&&(l.hasOne[i]=e.hasOne[i]);for(var i in e.hasMany)e.hasMany.hasOwnProperty(i)&&(e.hasMany[i].mixin=t,l.hasMany[i]=e.hasMany[i])};for(var c=t.entityDecoratorHooks,h=0;h<c.length;h++)c[h](o);return T[i]=o,o}function o(){if(t.typeMapper&&t.typeMapper.newUuid)return t.typeMapper.newUuid();for(var e=[],n="0123456789ABCDEF",i=0;i<32;i++)e[i]=n.substr(Math.floor(16*Math.random()),1);e[12]="4",e[16]=n.substr(3&e[16]|8,1);var r=e.join("");return r}function a(e){if(t.typeMapper&&t.typeMapper.defaultValue)return t.typeMapper.defaultValue(e);switch(e){case"TEXT":return"";case"BOOL":return!1;default:return e.indexOf("INT")!==-1?0:e.indexOf("CHAR")!==-1?"":null}}function s(t,e){for(var n=t.length,i=0;i<n;i++){var r=t[i];if(r.equals&&r.equals(e))return!0;if(r===e)return!0}return!1}function l(t,e){for(var n=t.length,i=0;i<n;i++){var r=t[i];if(r.equals&&r.equals(e))return void t.splice(i,1);if(r===e)return void t.splice(i,1)}}function c(t,e,n){this.obj=t,this.eventType=e,this.fn=n}function u(){this.subscribers={}}function h(){}function p(t,e){this.left=t,this.right=e}function f(t,e){this.left=t,this.right=e}function d(t,e,n){this.property=t,this.operator=e.toLowerCase(),this.value=n}function y(){}function v(t,e){this.init(t,e,v)}function m(t,e){this.init(t,e,m)}function g(e,n){this.init(e,n,t.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function b(e){this.init(t,null,b),this._items=e||[]}var _={},T={};t.getEntityMeta=function(){return _},t.trackedObjects={},t.objectsToRemove={},t.objectsRemoved=[],t.globalPropertyListeners={},t.queryCollectionCache={},t.getObjectsToRemove=function(){return this.objectsToRemove},t.getTrackedObjects=function(){return this.trackedObjects},t.entityDecoratorHooks=[],t.flushHooks=[],t.schemaSyncHooks=[],t.debug=!0,t.subscribeToGlobalPropertyListener=function(t,e,n){var i=e+"__"+n;if(i in this.globalPropertyListeners){for(var r=this.globalPropertyListeners[i],o=0;o<r.length;o++)if(r[o]===t)return;this.globalPropertyListeners[i].push(t)}else this.globalPropertyListeners[i]=[t]},t.unsubscribeFromGlobalPropertyListener=function(t,e,n){for(var i=e+"__"+n,r=this.globalPropertyListeners[i],o=0;o<r.length;o++)if(r[o]===t)return void r.splice(o,1)},t.propertyChanged=function(t,e,n,i){if(this.trackedObjects[t.id]){var r=t._type,o=r+"__"+e;if(o in this.globalPropertyListeners)for(var a=this.globalPropertyListeners[o],s=0;s<a.length;s++){var l=a[s],c=t._data;c[e]=n;var u=l._filter.match(c);c[e]=i;var h=l._filter.match(c);u!=h&&l.triggerEvent("change",l,t)}}},t.objectRemoved=function(t){var e=t._type;if(this.queryCollectionCache[e]){var n=this.queryCollectionCache[e];for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];r._filter.match(t)&&r.triggerEvent("change",r,t)}}},t.getMeta=n,i.prototype=t,t.Session=i,t.define=function(t,e){if(_[t])return r(t);var n={name:t,fields:e,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};return _[t]=n,r(t)},t.isDefined=function(t){return!!_[t]},t.defineMixin=function(t,e){var n=this.define(t,e);return n.meta.isMixin=!0,n},t.isTransaction=function(t){return!t||t&&t.executeSql},t.isSession=function(t){return!t||t&&t.schemaSync},t.add=function(t){if(t){if(!this.trackedObjects[t.id]&&(this.trackedObjects[t.id]=t,t._new))for(var e in t._data)t._data.hasOwnProperty(e)&&this.propertyChanged(t,e,void 0,t._data[e]);return this}},t.remove=function(t){return t._new?delete this.trackedObjects[t.id]:(this.objectsToRemove[t.id]||(this.objectsToRemove[t.id]=t),this.objectsRemoved.push({id:t.id,entity:t._type})),this.objectRemoved(t),this},t.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={}},t.asyncForEach=function(t,e,n){function i(){var r=t.pop();e(r,function(e,r){t.length>0?i():n(e,r)})}t=t.slice(0),t.length>0?i():n()},t.asyncParForEach=function(t,e,n){var i=0,r=t.length;0===r&&n();for(var o=0;o<r;o++)e(t[o],function(t,e){i++,i===r&&n(t,e)})},t.jsonToEntityVal=function(t,e){if(!e)return t;switch(e){case"DATE":return"number"==typeof t?t>1e12?new Date(t):new Date(1e3*t):null;default:return t}},t.entityValToJson=function(t,e){if(!e)return t;switch(e){case"DATE":return t?(t=new Date(t),Math.round(t.getTime()/1e3)):null;default:return t}},t.dump=function(n,i,r){var o=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(t){return!t||t&&t.length&&!t.apply},defaultValue:null},{name:"callback",optional:!1,check:e.isCallback(),defaultValue:function(){}}]);if(n=o.tx,i=o.entities,r=o.callback,!i){i=[];for(var a in T)T.hasOwnProperty(a)&&i.push(T[a])}var s={};t.asyncParForEach(i,function(e,i){e.all().list(n,function(r){var o=[];t.asyncParForEach(r,function(i,r){var a={},s=e.meta.fields;for(var l in s)s.hasOwnProperty(l)&&(a[l]=t.entityValToJson(i._data[l],s[l]));var c=e.meta.hasOne;for(var u in c)c.hasOwnProperty(u)&&(a[u]=i._data[u]);var h=e.meta.hasMany,p=[];for(var f in h)h.hasOwnProperty(f)&&p.push(f);t.asyncParForEach(p,function(e,r){var o=t.get(i,e);o.list(n,function(t){a[e]=t.map(function(t){return t.id}),r()})},function(){a.id=i.id,o.push(a),r()})},function(){s[e.meta.name]=o,i()})})},function(){r(s)})},t.load=function(n,i,o){var a=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:e.isCallback(),defaultValue:function(){}}]);n=a.tx,i=a.dump,o=a.callback;var s=[],l=this;for(var c in i)if(i.hasOwnProperty(c))for(var u=r(c),h=u.meta.fields,p=i[c],f=0;f<p.length;f++){var d=p[f],y=new u;y.id=d.id;for(var v in d)if(d.hasOwnProperty(v))if(t.isImmutable(v))y[v]=d[v];else if(u.meta.hasMany[v]){var m=u.meta.hasMany[v];if(m.manyToMany&&u.meta.name<m.type.meta.name)continue;var g=t.get(y,v);d[v].length>0&&d[v].forEach(function(t){s.push({Entity:u,coll:g,id:t})})}else t.set(y,v,t.jsonToEntityVal(d[v],h[v]));this.add(y)}l.flush(n,function(){t.asyncForEach(s,function(t,e){t.Entity.load(l,n,t.id,function(n){t.coll.add(n),e()})},function(){l.flush(n,o)})})},t.dumpToJson=function(n,i,r){var o=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(t){return t&&t.length&&!t.apply},defaultValue:null},{name:"callback",optional:!1,check:e.isCallback(),defaultValue:function(){}}]);n=o.tx,i=o.entities,r=o.callback,this.dump(n,i,function(t){r(JSON.stringify(t))})},t.loadFromJson=function(n,i,r){var o=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:e.isCallback(),defaultValue:function(){}}]);n=o.tx,i=o.jsonDump,r=o.callback,this.load(n,JSON.parse(i),r)},t.createUUID=o,c.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},u.prototype.addEventListener=function(t,e){return this.subscribers[t]||(this.subscribers[t]=[]),this.subscribers[t].push(e),new c(this,t,e)},u.prototype.removeEventListener=function(t,e){for(var n=this.subscribers[t],i=0;i<n.length;i++)if(n[i]==e)return this.subscribers[t].splice(i,1),!0;return!1},u.prototype.triggerEvent=function(t){if(this.subscribers[t])for(var e=this.subscribers[t].slice(0),n=0;n<e.length;n++)e[n].apply(null,arguments)},h.prototype.match=function(t){return!0},h.prototype.makeFit=function(t){},h.prototype.makeNotFit=function(t){},h.prototype.toUniqueString=function(){return"NULL"},h.prototype.subscribeGlobally=function(){},h.prototype.unsubscribeGlobally=function(){},p.prototype.match=function(t){return this.left.match(t)&&this.right.match(t)},p.prototype.makeFit=function(t){this.left.makeFit(t),this.right.makeFit(t)},p.prototype.makeNotFit=function(t){this.left.makeNotFit(t),this.right.makeNotFit(t)},p.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},p.prototype.subscribeGlobally=function(t,e){this.left.subscribeGlobally(t,e),this.right.subscribeGlobally(t,e)},p.prototype.unsubscribeGlobally=function(t,e){this.left.unsubscribeGlobally(t,e),this.right.unsubscribeGlobally(t,e)},f.prototype.match=function(t){return this.left.match(t)||this.right.match(t)},f.prototype.makeFit=function(t){this.left.makeFit(t),this.right.makeFit(t)},f.prototype.makeNotFit=function(t){this.left.makeNotFit(t),this.right.makeNotFit(t)},f.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},f.prototype.subscribeGlobally=function(t,e){this.left.subscribeGlobally(t,e),this.right.subscribeGlobally(t,e)},f.prototype.unsubscribeGlobally=function(t,e){this.left.unsubscribeGlobally(t,e),this.right.unsubscribeGlobally(t,e)},d.prototype.match=function(e){var n=this.value,i=t.get(e,this.property);switch(n&&n.getTime&&(n=1e3*Math.round(n.getTime()/1e3),i&&i.getTime&&(i=1e3*Math.round(i.getTime()/1e3))),this.operator){case"=":return i===n;case"!=":return i!==n;case"<":return i<n;case"<=":return i<=n;case">":return i>n;case">=":return i>=n;case"in":return s(n,i);case"not in":return!s(n,i)}},d.prototype.makeFit=function(e){if("="!==this.operator)throw new Error("Sorry, can't perform makeFit for other filters than =");t.set(e,this.property,this.value)},d.prototype.makeNotFit=function(e){if("="!==this.operator)throw new Error("Sorry, can't perform makeNotFit for other filters than =");t.set(e,this.property,null)},d.prototype.subscribeGlobally=function(e,n){t.subscribeToGlobalPropertyListener(e,n,this.property)},d.prototype.unsubscribeGlobally=function(e,n){t.unsubscribeFromGlobalPropertyListener(e,n,this.property)},d.prototype.toUniqueString=function(){var t=this.value;return t&&t._type&&(t=t.id),this.property+this.operator+t},t.NullFilter=h,t.AndFilter=p,t.OrFilter=f,t.PropertyFilter=d,t.uniqueQueryCollection=function(t){var e=t._entityName;if(t._items)return t;this.queryCollectionCache[e]||(this.queryCollectionCache[e]={});var n=t.toUniqueString();return this.queryCollectionCache[e][n]||(this.queryCollectionCache[e][n]=t),this.queryCollectionCache[e][n]},y.prototype=new u,y.prototype.oldAddEventListener=y.prototype.addEventListener,y.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},y.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},y.prototype.addEventListener=function(t,e){var n=this,i=this.oldAddEventListener(t,e);return 1===this.subscribers[t].length&&this.setupSubscriptions(),i.oldUnsubscribe=i.unsubscribe,i.unsubscribe=function(){this.oldUnsubscribe(),0===n.subscribers[t].length&&n.teardownSubscriptions()},i},y.prototype.persistQueries=function(){return[]},y.prototype.init=function(e,n,i){this._filter=new h,this._orderColumns=[],this._prefetchFields=[],this._entityName=n,this._constructor=i,this._limit=-1,this._skip=0,this._reverse=!1,this._session=e||t,this.subscribers={}},y.prototype.toUniqueString=function(){var t=this._constructor.name+": "+this._entityName;t+="|Filter:";var e=[];t+=this._filter.toUniqueString(),t+="|Values:";for(var n=0;n<e.length;n++)t+=e+"|^|";t+="|Order:";for(var n=0;n<this._orderColumns.length;n++){var i=this._orderColumns[n];t+=i[0]+", "+i[1]+", "+i[2]}t+="|Prefetch:";for(var n=0;n<this._prefetchFields.length;n++)t+=this._prefetchFields[n];return t+="|Limit:",t+=this._limit,t+="|Skip:",t+=this._skip,t+="|Reverse:",t+=this._reverse},y.prototype.clone=function(t){var e=new this._constructor(this._session,this._entityName);if(e._filter=this._filter,e._prefetchFields=this._prefetchFields.slice(0),e._orderColumns=this._orderColumns.slice(0),e._limit=this._limit,e._skip=this._skip,e._reverse=this._reverse,t){var n={};for(var i in this.subscribers)this.subscribers.hasOwnProperty(i)&&(n[i]=this.subscribers[i].slice(0));e.subscribers=n}else e.subscribers=this.subscribers;return e},y.prototype.filter=function(t,e,n){var i=this.clone(!0);i._filter=new p(this._filter,new d(t,e,n));var r=this._session;return i=r.uniqueQueryCollection(i),r.uniqueQueryCollection(i)},y.prototype.or=function(t){var e=this.clone(!0);return e._filter=new f(this._filter,t),this._session.uniqueQueryCollection(e)},y.prototype.and=function(t){var e=this.clone(!0);return e._filter=new p(this._filter,t),this._session.uniqueQueryCollection(e)},y.prototype.order=function(t,e,n){e=void 0===e||e,n=void 0===n||n;var i=this.clone();return i._orderColumns.push([t,e,n]),this._session.uniqueQueryCollection(i)},y.prototype.limit=function(t){var e=this.clone();return e._limit=t,this._session.uniqueQueryCollection(e)},y.prototype.skip=function(t){var e=this.clone();return e._skip=t,this._session.uniqueQueryCollection(e)},y.prototype.reverse=function(){var t=this.clone();return t._reverse=!0,this._session.uniqueQueryCollection(t)},y.prototype.prefetch=function(t){var e=this.clone();return e._prefetchFields.push(t),this._session.uniqueQueryCollection(e)},y.prototype.selectJSON=function(n,i,o){var a=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),s=this._session,l=this;if(n=a.tx,i=a.props,o=a.callback,!n)return void s.transaction(function(t){l.selectJSON(t,i,o)});r(this._entityName);this.list(function(e){var r=[];t.asyncForEach(e,function(t,e){t.selectJSON(n,i,function(t){r.push(t),e()})},function(){o(r)})})},y.prototype.add=function(t){if(!t.id||!t._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(t),this._filter.makeFit(t),this.triggerEvent("add",this,t),this.triggerEvent("change",this,t)},y.prototype.addAll=function(t){for(var e=0;e<t.length;e++){var n=t[e];this._session.add(n),this._filter.makeFit(n),this.triggerEvent("add",this,n)}this.triggerEvent("change",this)},y.prototype.remove=function(t){if(!t.id||!t._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(t),this.triggerEvent("remove",this,t),this.triggerEvent("change",this,t)},y.prototype.each=function(n,i){var r=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:e.isCallback()}]);n=r.tx,i=r.eachFn,this.list(n,function(t){for(var e=0;e<t.length;e++)i(t[e])})},y.prototype.forEach=y.prototype.each,y.prototype.one=function(n,i){var r=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:e.isCallback()}]);n=r.tx,i=r.oneFn;this.limit(1).list(n,function(t){i(0===t.length?null:t[0])})},v.prototype=new y,m.prototype=new v,m.prototype.add=function(t){this._session.add(t),this.triggerEvent("add",this,t),this.triggerEvent("change",this,t)},m.prototype.remove=function(t){this._session.remove(t),this.triggerEvent("remove",this,t),this.triggerEvent("change",this,t)},g.prototype=new v,g.prototype.initManyToMany=function(t,e){this._obj=t,this._coll=e},g.prototype.add=function(t){s(this._localAdded,t)||(this._session.add(t),this._localAdded.push(t),this.triggerEvent("add",this,t),this.triggerEvent("change",this,t))},g.prototype.addAll=function(t){for(var e=0;e<t.length;e++){var n=t[e];s(this._localAdded,n)||(this._session.add(n),this._localAdded.push(n),this.triggerEvent("add",this,n))}this.triggerEvent("change",this)},g.prototype.clone=function(){var t=v.prototype.clone.call(this);return t._localAdded=this._localAdded,t._localRemoved=this._localRemoved,t._obj=this._obj,t._coll=this._coll,t},g.prototype.remove=function(t){s(this._localAdded,t)?l(this._localAdded,t):s(this._localRemoved,t)||this._localRemoved.push(t),this.triggerEvent("remove",this,t),this.triggerEvent("change",this,t)},b.prototype=new y,b.prototype.clone=function(){var t=v.prototype.clone.call(this);return t._items=this._items,t},b.prototype.add=function(t){s(this._items,t)||(this._session.add(t),this._items.push(t),this.triggerEvent("add",this,t),this.triggerEvent("change",this,t))},b.prototype.addAll=function(t){for(var e=0;e<t.length;e++){var n=t[e];s(this._items,n)||(this._session.add(n),this._items.push(n),this.triggerEvent("add",this,n))}this.triggerEvent("change",this)},b.prototype.remove=function(t){for(var e=this._items,n=0;n<e.length;n++)e[n]===t&&(this._items.splice(n,1),this.triggerEvent("remove",this,t),this.triggerEvent("change",this,t))},b.prototype.list=function(n,i){var r=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:e.isCallback()}]);i=r.callback,i&&!i.executeSql||(i=arguments[1]);for(var o=this._items.slice(0),a=this,s=[],l=0;l<o.length;l++)this._filter.match(o[l])&&s.push(o[l]);return s.sort(function(e,n){for(var i=0;i<a._orderColumns.length;i++){var r=a._orderColumns[i][0],o=a._orderColumns[i][1],s=a._orderColumns[i][2],l=t.get(e,r),c=t.get(n,r);if(s||(l=l.toLowerCase(),c=c.toLowerCase()),l<c)return o?-1:1;if(l>c)return o?1:-1}return 0}),this._skip&&s.splice(0,this._skip),this._limit>-1&&(s=s.slice(0,this._limit)),this._reverse&&s.reverse(),i?void i(s):s},b.prototype.destroyAll=function(t){t&&!t.executeSql||(t=arguments[1]),this._items=[],this.triggerEvent("change",this),t&&t()},b.prototype.count=function(n,i){var r=e.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:e.isCallback()}]);n=r.tx,i=r.callback;var o=this.list();return i?void i(o.length):o.length},t.QueryCollection=y,t.DbQueryCollection=v,t.ManyToManyDbQueryCollection=g,t.LocalQueryCollection=b,t.Observable=u,t.Subscription=c,t.AndFilter=p,t.OrFilter=f,t.PropertyFilter=d}();var e={};return function(){e.getArgs=function(t,e){for(var n=0,i=0,r={};i<e.length;){var o=e[i],a=t[n];if(o.optional)void 0!==a&&o.check(a)?(r[o.name]=a,n++,i++):(void 0!==o.defaultValue&&(r[o.name]=o.defaultValue),i++);else{if(o.check&&!o.check(a))throw new Error("Invalid value for argument: "+o.name+" Value: "+a);r[o.name]=a,i++,n++}}return r},e.hasProperty=function(t){return function(e){return e&&void 0!==e[t]}},e.hasType=function(t){return function(e){return typeof e===t}},e.isCallback=function(){return function(t){return t&&t.apply}}}(),t.argspec=e,t}function config(t,e){function n(e,n,i,r){if(r=r||"",e.trackedObjects[i[r+"id"]])return e.trackedObjects[i[r+"id"]];var o=t.typeMapper,a=t.getMeta(n),s=t.define(n);if(!i[r+"id"])return null;var l=new s(e,(void 0),(!0));l.id=o.dbValToEntityVal(i[r+"id"],o.idType),l._new=!1;for(var c in i)if(i.hasOwnProperty(c)&&c.substring(0,r.length)===r){var u=c.substring(r.length);"id"!=u&&(l._data[u]=o.dbValToEntityVal(i[c],a.fields[u]||o.idType))}return l}function i(e,n,i){var r=t.getMeta(e._type),a=t.typeMapper,s=[],l=[],c=[],u=[];if(e._new)for(var h in r.fields)r.fields.hasOwnProperty(h)&&(e._dirtyProperties[h]=!0);for(var h in e._dirtyProperties)if(e._dirtyProperties.hasOwnProperty(h)){s.push("`"+h+"`");var p=r.fields[h]||a.idType;l.push(a.entityValToDbVal(e._data[h],p)),c.push(a.outVar("?",p)),u.push("`"+h+"` = "+a.outVar("?",p))}var f=[];if(r&&r.hasMany)for(var h in r.hasMany)r.hasMany.hasOwnProperty(h)&&(f=f.concat(t.get(e,h).persistQueries()));o(n,f,function(){if(!e._new&&0===s.length)return void(i&&i());if(e._dirtyProperties={},e._new){s.push("id"),l.push(a.entityIdToDbId(e.id)),c.push(a.outIdVar("?"));var t="INSERT INTO `"+e._type+"` ("+s.join(", ")+") VALUES ("+c.join(", ")+")";e._new=!1,n.executeSql(t,l,i,i)}else{var t="UPDATE `"+e._type+"` SET "+u.join(",")+" WHERE id = "+a.outId(e.id);n.executeSql(t,l,i,i)}})}function r(e,n,i){var r=t.getMeta(e._type),a=t.typeMapper,s=[["DELETE FROM `"+e._type+"` WHERE id = "+a.outId(e.id),null]];for(var l in r.hasMany)if(r.hasMany.hasOwnProperty(l)&&r.hasMany[l].manyToMany){var c=r.hasMany[l].tableName;s.push(["DELETE FROM `"+c+"` WHERE `"+r.name+"_"+l+"` = "+a.outId(e.id),null])}o(n,s,i)}function o(e,n,i){for(var r=[],o=3;o<arguments.length;o++)r.push(arguments[o]);t.asyncForEach(n,function(t,n){e.executeSql(t[0],t[1],n,function(t,e){console.log(e.message),n(t,e)})},function(t,e){return e&&i?void i(t,e):void(i&&i.apply(null,r))})}var a=t.argspec;t.typeMapper=e.typeMapper||defaultTypeMapper,t.generatedTables={},t.schemaSync=function(n,i,r){var s=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:a.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:a.hasType("boolean")}]);if(n=s.tx,i=s.callback,r=s.emulate,!n){var l=this;return void this.transaction(function(t){l.schemaSync(t,i,r)})}var c,u,h,p,f=[],d=t.typeMapper,y=t.getEntityMeta();for(var v in y)if(y.hasOwnProperty(v)){if(c=y[v],!c.isMixin){u=[];for(var m in c.fields)c.fields.hasOwnProperty(m)&&u.push([m,c.fields[m]]);for(var g in c.hasOne)c.hasOne.hasOwnProperty(g)&&(h=c.hasOne[g].type.meta,u.push([g,d.idType]),f.push([e.createIndex(c.name,[g]),null]));for(var b=0;b<c.indexes.length;b++)f.push([e.createIndex(c.name,c.indexes[b].columns,c.indexes[b]),null])}for(var g in c.hasMany)if(c.hasMany.hasOwnProperty(g)&&c.hasMany[g].manyToMany&&(p=c.hasMany[g].tableName,!t.generatedTables[p])){var h=c.hasMany[g].type.meta,_=c.hasMany[g].inverseProperty;if(h.hasMany[_].type.meta!=c)continue;var T=c.name+"_"+g,w=h.name+"_"+_;f.push([e.createIndex(p,[T]),null]),f.push([e.createIndex(p,[w]),null]);var O=[[T,d.idType],[w,d.idType]];c.isMixin&&O.push([T+"_class",d.classNameType]),h.isMixin&&O.push([w+"_class",d.classNameType]),f.push([e.createTable(p,O),null]),t.generatedTables[p]=!0}c.isMixin||(u.push(["id",d.idType,"PRIMARY KEY"]),t.generatedTables[c.name]=!0,f.push([e.createTable(c.name,u),null]))}for(var k=t.schemaSyncHooks,b=0;b<k.length;b++)k[b](n);r?i(n):o(n,f,function(t,e){i(n,e)})},t.flush=function(e,n){var o=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction},{name:"callback",optional:!0,check:a.isCallback(),defaultValue:null}]);e=o.tx,n=o.callback;var s=this;if(!e)return void this.transaction(function(t){s.flush(t,n)});var l=t.flushHooks;t.asyncForEach(l,function(t,n){t(s,e,n)},function(){var o=[];for(var a in s.trackedObjects)s.trackedObjects.hasOwnProperty(a)&&o.push(s.trackedObjects[a]);var l=[];for(var a in s.objectsToRemove)s.objectsToRemove.hasOwnProperty(a)&&(l.push(s.objectsToRemove[a]),delete s.trackedObjects[a]);if(s.objectsToRemove={},n)t.asyncParForEach(l,function(t,n){r(t,e,n)},function(r,a){return a?n(r,a):void t.asyncParForEach(o,function(t,n){i(t,e,n)},n)});else{for(var c=0;c<o.length;c++)i(o[c],e);for(var c=0;c<l.length;c++)r(l[c],e)}})},t.reset=function(e,n){var i=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:a.isCallback(),defaultValue:function(){}}]);e=i.tx,n=i.callback;var r=this;return e?void this.schemaSync(e,function(){function i(){var t=a.pop();e.executeSql("DROP TABLE IF EXISTS `"+t+"`",null,function(){a.length>0?i():o()},o)}function o(e,i){r.clean(),t.generatedTables={},n&&n(e,i)}var a=[];for(var s in t.generatedTables)t.generatedTables.hasOwnProperty(s)&&a.push(s);
a.length>0?i():o()},!0):void r.transaction(function(t){r.reset(t,n)})},t.save=i,t.executeQueriesSeq=o,t.QueryCollection.prototype.persistQueries=function(){return[]};var s=t.QueryCollection.prototype.clone;t.QueryCollection.prototype.clone=function(t){var e=s.call(this,t);return e._additionalJoinSqls=this._additionalJoinSqls.slice(0),e._additionalWhereSqls=this._additionalWhereSqls.slice(0),e._additionalGroupSqls=this._additionalGroupSqls.slice(0),e._manyToManyFetch=this._manyToManyFetch,e};var l=t.QueryCollection.prototype.init;t.QueryCollection.prototype.init=function(t,e,n){l.call(this,t,e,n),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]};var c=t.QueryCollection.prototype.toUniqueString;t.QueryCollection.prototype.toUniqueString=function(){var t=c.call(this);t+="|JoinSQLs:";for(var e=0;e<this._additionalJoinSqls.length;e++)t+=this._additionalJoinSqls[e];t+="|WhereSQLs:";for(var e=0;e<this._additionalWhereSqls.length;e++)t+=this._additionalWhereSqls[e];t+="|GroupSQLs:";for(var e=0;e<this._additionalGroupSqls.length;e++)t+=this._additionalGroupSqls[e];return this._manyToManyFetch&&(t+="|ManyToManyFetch:",t+=JSON.stringify(this._manyToManyFetch)),t},t.NullFilter.prototype.sql=function(t,e,n){return"1=1"},t.AndFilter.prototype.sql=function(t,e,n){return"("+this.left.sql(t,e,n)+" AND "+this.right.sql(t,e,n)+")"},t.OrFilter.prototype.sql=function(t,e,n){return"("+this.left.sql(t,e,n)+" OR "+this.right.sql(t,e,n)+")"},t.PropertyFilter.prototype.sql=function(e,n,i){var r=t.typeMapper,o=n?"`"+n+"`.":"",a=e.fields[this.property]||r.idType;if("="===this.operator&&null===this.value)return o+"`"+this.property+"` IS NULL";if("!="===this.operator&&null===this.value)return o+"`"+this.property+"` IS NOT NULL";if("in"===this.operator){for(var s=this.value,l=[],c=0;c<s.length;c++)l.push("?"),i.push(r.entityValToDbVal(s[c],a));return 0===s.length?"1 = 0":o+"`"+this.property+"` IN ("+l.join(", ")+")"}if("not in"===this.operator){for(var s=this.value,l=[],c=0;c<s.length;c++)l.push("?"),i.push(r.entityValToDbVal(s[c],a));return 0===s.length?"1 = 1":o+"`"+this.property+"` NOT IN ("+l.join(", ")+")"}var u=this.value;return u!==!0&&u!==!1||(u=u?1:0),i.push(r.entityValToDbVal(u,a)),o+"`"+this.property+"` "+this.operator+" "+r.outVar("?",a)},t.DbQueryCollection.prototype.list=function(e,i){function r(t,e,n){var i=[h.inIdVar("`"+e+"`.id")+" AS "+n+"id"];for(var r in t.fields)t.fields.hasOwnProperty(r)&&i.push(h.inVar("`"+e+"`.`"+r+"`",t.fields[r])+" AS `"+n+r+"`");for(var r in t.hasOne)t.hasOne.hasOwnProperty(r)&&i.push(h.inIdVar("`"+e+"`.`"+r+"`")+" AS `"+n+r+"`");return i}var o=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:a.isCallback()}]);e=o.tx,i=o.callback;var s=this,l=this._session;if(!e)return void l.transaction(function(t){s.list(t,i)});var c=this._entityName,u=t.getMeta(c),h=t.typeMapper;if(u.isMixin){var p=[];return void t.asyncForEach(u.mixedIns,function(t,n){var i=s.clone();i._entityName=t.name,i.list(e,function(t){p=p.concat(t),n()})},function(){var e=new t.LocalQueryCollection(p);e._orderColumns=s._orderColumns,e._reverse=s._reverse,e.list(null,i)})}var o=[],f=c+"_",d="root",y=r(u,d,f),v="",m=this._additionalWhereSqls.slice(0),g=this._manyToManyFetch;g&&(v+="LEFT JOIN `"+g.table+"` AS mtm ON mtm.`"+g.inverseProp+"` = `root`.`id` ",m.push("mtm.`"+g.prop+"` = "+h.outId(g.id))),v+=this._additionalJoinSqls.join(" ");for(var b=0;b<this._prefetchFields.length;b++){var _=this._prefetchFields[b].split("."),T=_[0],w=c;_.length>1&&(T=_[1],w=_[0]);var O=t.getMeta(w),k=O.hasOne[T].type.meta;if(k.isMixin)throw new Error("cannot prefetch a mixin");var E=k.name+"_"+T+"_tbl",S=d;_.length>1&&(S=w+"_"+w+"_tbl"),y=y.concat(r(k,E,T+"_")),v+="LEFT JOIN `"+k.name+"` AS `"+E+"` ON `"+E+"`.`id` = `"+S+"`.`"+T+"` "}var M="WHERE "+[this._filter.sql(u,d,o)].concat(m).join(" AND "),x="SELECT "+y.join(", ")+" FROM `"+c+"` AS `"+d+"` "+v+" "+M;this._additionalGroupSqls.length>0&&(x+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(x+=" ORDER BY "+this._orderColumns.map(function(t){return(t[2]?"`":"LOWER(`")+f+t[0]+(t[2]?"` ":"`) ")+(t[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(x+=" LIMIT "+this._limit),this._skip>0&&(x+=" OFFSET "+this._skip),l.flush(e,function(){e.executeSql(x,o,function(e){var r=[];s._reverse&&e.reverse();for(var o=0;o<e.length;o++){for(var a=e[o],u=n(l,c,a,f),h=0;h<s._prefetchFields.length;h++){var p=s._prefetchFields[h].split("."),d=p[0],y=c;p.length>1&&(d=p[1],y=p[0]);var v=t.getMeta(y),m=v.hasOne[d].type.meta;u._data_obj[d]=n(l,m.name,a,d+"_"),l.add(u._data_obj[d])}r.push(u),l.add(u)}i(r),s.triggerEvent("list",s,r)})})},t.DbQueryCollection.prototype.destroyAll=function(e,n){var i=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:a.isCallback(),defaultValue:function(){}}]);e=i.tx,n=i.callback;var r=this,o=this._session;if(!e)return void o.transaction(function(t){r.destroyAll(t,n)});var s=this._entityName,l=t.getMeta(s),c=t.typeMapper;if(l.isMixin)return void t.asyncForEach(l.mixedIns,function(t,i){var o=r.clone();o._entityName=t.name,o.destroyAll(e,n)},n);var u="",h=this._additionalWhereSqls.slice(0),p=this._manyToManyFetch;p&&(u+="LEFT JOIN `"+p.table+"` AS mtm ON mtm.`"+p.inverseProp+"` = `root`.`id` ",h.push("mtm.`"+p.prop+"` = "+c.outId(p.id))),u+=this._additionalJoinSqls.join(" ");var i=[],f="WHERE "+[this._filter.sql(l,null,i)].concat(h).join(" AND "),d="SELECT id FROM `"+s+"` "+u+" "+f,y="DELETE FROM `"+s+"` "+u+" "+f,v=i.slice(0);o.flush(e,function(){e.executeSql(d,i,function(t){for(var i=0;i<t.length;i++)delete o.trackedObjects[t[i].id],o.objectsRemoved.push({id:t[i].id,entity:s});r.triggerEvent("change",r),e.executeSql(y,v,n,n)},n)})},t.DbQueryCollection.prototype.count=function(e,n){var i=a.getArgs(arguments,[{name:"tx",optional:!0,check:t.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:a.isCallback()}]);e=i.tx,n=i.callback;var r=this,o=this._session;if(e&&!e.executeSql&&(n=e,e=null),!e)return void o.transaction(function(t){r.count(t,n)});var s=this._entityName,l=t.getMeta(s),c=t.typeMapper;if(l.isMixin){var u=0;return void t.asyncForEach(l.mixedIns,function(t,n){var i=r.clone();i._entityName=t.name,i.count(e,function(t){u+=t,n()})},function(){n(u)})}var h="",p=this._additionalWhereSqls.slice(0),f=this._manyToManyFetch;f&&(h+="LEFT JOIN `"+f.table+"` AS mtm ON mtm.`"+f.inverseProp+"` = `root`.`id` ",p.push("mtm.`"+f.prop+"` = "+c.outId(f.id))),h+=this._additionalJoinSqls.join(" ");var i=[],d="WHERE "+[this._filter.sql(l,"root",i)].concat(p).join(" AND "),y="SELECT COUNT(*) AS cnt FROM `"+s+"` AS `root` "+h+" "+d;o.flush(e,function(){e.executeSql(y,i,function(t){n(parseInt(t[0].cnt,10))})})},t.ManyToManyDbQueryCollection.prototype.persistQueries=function(){for(var e=[],n=t.getMeta(this._obj._type),i=n.hasMany[this._coll].type.meta,r=t.typeMapper,o=n.hasMany[this._coll],a=i.hasMany[o.inverseProperty],s=o.mixin?o.mixin.meta.name:n.name,l=a.mixin?a.mixin.meta.name:i.name,c=0;c<this._localAdded.length;c++){var u=[s+"_"+this._coll,l+"_"+o.inverseProperty],h=[r.outIdVar("?"),r.outIdVar("?")],p=[r.entityIdToDbId(this._obj.id),r.entityIdToDbId(this._localAdded[c].id)];o.mixin&&(u.push(s+"_"+this._coll+"_class"),h.push("?"),p.push(n.name)),a.mixin&&(u.push(l+"_"+o.inverseProperty+"_class"),h.push("?"),p.push(i.name)),e.push(["INSERT INTO "+o.tableName+" (`"+u.join("`, `")+"`) VALUES ("+h.join(",")+")",p])}this._localAdded=[];for(var c=0;c<this._localRemoved.length;c++)e.push(["DELETE FROM  "+o.tableName+" WHERE `"+s+"_"+this._coll+"` = "+r.outIdVar("?")+" AND `"+l+"_"+o.inverseProperty+"` = "+r.outIdVar("?"),[r.entityIdToDbId(this._obj.id),r.entityIdToDbId(this._localRemoved[c].id)]]);return this._localRemoved=[],e}}if("undefined"!=typeof exports){exports.createPersistence=function(){return initPersistence({})};var singleton;"function"==typeof exports.__defineGetter__?exports.__defineGetter__("persistence",function(){return singleton||(singleton=exports.createPersistence()),singleton}):Object.defineProperty(exports,"persistence",{get:function(){return singleton||(singleton=exports.createPersistence()),singleton},enumerable:!0,configurable:!0})}else window=window||{},window.persistence=initPersistence(window.persistence||{});"undefined"==typeof JSON&&(JSON={}),JSON.stringify||!function(){function f(t){return t<10?"0"+t:t}function quote(t){return escapable.lastIndex=0,escapable.test(t)?'"'+t.replace(escapable,function(t){var e=meta[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var n,i,r,o,a,s=gap,l=e[t];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(t)),"function"==typeof rep&&(l=rep.call(e,t,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(l)){for(o=l.length,n=0;n<o;n+=1)a[n]=str(n,l)||"null";return r=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+s+"]":"["+a.join(",")+"]",gap=s,r}if(rep&&"object"==typeof rep)for(o=rep.length,n=0;n<o;n+=1)i=rep[n],"string"==typeof i&&(r=str(i,l),r&&a.push(quote(i)+(gap?": ":":")+r));else for(i in l)Object.hasOwnProperty.call(l,i)&&(r=str(i,l),r&&a.push(quote(i)+(gap?": ":":")+r));return r=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+s+"}":"{"+a.join(",")+"}",gap=s,r}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(t){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(t){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(t,e,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;i<n;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=e,e&&"function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw new Error("JSON.stringify");return str("",{"":t})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(t,e){var n,i,r=t[e];if(r&&"object"==typeof r)for(n in r)Object.hasOwnProperty.call(r,n)&&(i=walk(r,n),void 0!==i?r[n]=i:delete r[n]);return reviver.call(t,e,r)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(t){switch(t){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return t}},inVar:function(t,e){return t},outVar:function(t,e){return t},outId:function(t){return"'"+t+"'"},dbValToEntityVal:function(t,e){if(null===t||void 0===t)return t;switch(e){case"DATE":return t>1e12?new Date(parseInt(t,10)):new Date(1e3*parseInt(t,10));case"BOOL":return 1===t||"1"===t;case"INT":return+t;case"BIGINT":return+t;case"JSON":return t?JSON.parse(t):t;default:return t}},entityValToDbVal:function(t,e){return void 0===t||null===t?null:"JSON"===e&&t?JSON.stringify(t):t.id?t.id:"BOOL"===e?"false"===t?0:t?1:0:"DATE"===e||t.getTime?(t=new Date(t),Math.round(t.getTime()/1e3)):"VARCHAR(32)"===e?t.toString():t},inIdVar:function(t){return this.inVar(t,this.idType)},outIdVar:function(t){return this.outVar(t,this.idType)},entityIdToDbId:function(t){return this.entityValToDbVal(t,this.idType)}};"undefined"!=typeof exports?(exports.defaultTypeMapper=defaultTypeMapper,exports.config=config):(window=window||{},window.persistence=window.persistence||persistence||{},window.persistence.store=window.persistence.store||{},window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config});try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.cordovasql={},persistence.store.cordovasql.config=function(t,e,n,i,r,o,a){var s=null;if(t.transaction=function(t){if(!s)throw new Error("No ongoing database connection, please connect first.");s.transaction(t)},t.db=t.db||{},t.db.implementation="unsupported",t.db.conn=null,window&&"sqlitePlugin"in window?t.db.implementation="sqliteplugin":window&&window.openDatabase&&(t.db.implementation="websql"),t.db.sqliteplugin={},t.db.sqliteplugin.connect=function(e,n,i){var r={},o=window.sqlitePlugin.openDatabase({name:e,bgType:n,location:i||0});return r.transaction=function(e){return o.transaction(function(n){return e(t.db.websql.transaction(n))})},r},t.db.sqliteplugin.transaction=function(e){var n={};return n.executeSql=function(n,i,r,o){t.debug&&console.log(n,i),e.executeSql(n,i,function(t,e){if(r){for(var n=[],i=0;i<e.rows.length;i++)n.push(e.rows.item(i));r(n)}},o)},n},t.db.websql={},t.db.websql.connect=function(e,n,i,r){var o={},a=openDatabase(e,n,i,r);return o.transaction=function(e){return a.transaction(function(n){return e(t.db.websql.transaction(n))})},o},t.db.websql.transaction=function(e){var n={};return n.executeSql=function(n,i,r,o){t.debug&&console.log(n,i),e.executeSql(n,i,function(t,e){if(r){for(var n=[],i=0;i<e.rows.length;i++)n.push(e.rows.item(i));r(n)}},o)},n},t.db.connect=function(e,n,i,r,o,a){return"sqliteplugin"==t.db.implementation?(console.log("persistence.db.implementation:sqliteplugin"),t.db.sqliteplugin.connect(e,o,a)):"websql"==t.db.implementation?(console.log("persistence.db.implementation:websql"),t.db.websql.connect(e,n,i,r)):null},t.store.cordovasql.sqliteDialect={createTable:function(e,n){for(var i=t.typeMapper,r="CREATE TABLE IF NOT EXISTS `"+e+"` (",o=[],a=0;a<n.length;a++){var s=n[a];o.push("`"+s[0]+"` "+i.columnType(s[1])+(s[2]?" "+s[2]:""))}return r+=o.join(", "),r+=")"},createIndex:function(t,e,n){return n=n||{},"CREATE "+(n.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+t+"__"+e.join("_")+"` ON `"+t+"` ("+e.map(function(t){return"`"+t+"`"}).join(", ")+")"}},t.store.sql.config(t,t.store.cordovasql.sqliteDialect),s=t.db.connect(e,n,i,r,o,a),!s)throw new Error("No supported database found in this browser.")};try{exports.persistence=persistence}catch(e){}