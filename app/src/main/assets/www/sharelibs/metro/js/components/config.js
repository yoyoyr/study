!function(){var e=function(e,t,n,a){var i=this;this.RowType={CELL1:"row cells",CELL2:"row cells2",CELL3:"row cells3"},this.ComponentsType={SELECT:"select",RADIOBUTTON:"radiobutton",TEXTINPUT:"textinput",SWITCH:"switch",BUTTON:"button",PASSWORDINPUT:"passwordinput"},this.PARAMS_KEYS={KEY_TSSPARAMS_VERSION:"tssparamsVersion",KEY_BUSINESSID:"businessId",KEY_MERCHANTNO:"merchantNo",KEY_MERCHANTNAME:"merchantName",KEY_MERCHANTNAME_ENG:"merchantNameEng",KEY_TERMINALNO:"terminalNo",KEY_IP:"ip",KEY_PORT:"port",KEY_TPDU:"tpdu",KEY_ISVOIDPIN:"isVoidPin",KEY_TIMEOUT:"timeout",KEY_CHONGZFAILTIMES:"chongzFailTimes",KEY_UPLOADFAILTIMES:"uploadFailTimes",KEY_PINPADTYPE:"pinPadType",KEY_MASTERKEYINDEX:"masterKeyIndex",KEY_PRINT_NUM:"printNum",KEY_REFUND_ALLOWANCE:"refundAllowance",KEY_RESERVE_LABEL:"reserveLabel",KEY_SCAN_TYPE:"scanType",KEY_SUPER_PWD:"superPwd",KEY_CODE_TYPE:"codeType",KEY_TRANS_CONTROLLER:"transController"},this.TSS_PARAMS_TO_CONFIG_MAPPING={"01000001":i.PARAMS_KEYS.KEY_MERCHANTNO,"01000002":i.PARAMS_KEYS.KEY_MERCHANTNAME,"01000003":i.PARAMS_KEYS.KEY_MERCHANTNAME_ENG,"01000005":i.PARAMS_KEYS.KEY_TERMINALNO,"04000029":i.PARAMS_KEYS.KEY_IP,"04000030":i.PARAMS_KEYS.KEY_PORT,"04000002":i.PARAMS_KEYS.KEY_TPDU,"02000002":i.PARAMS_KEYS.KEY_ISVOIDPIN,"03000009":i.PARAMS_KEYS.KEY_PRINT_NUM,"02000009":i.PARAMS_KEYS.KEY_REFUND_ALLOWANCE,"03000003":i.PARAMS_KEYS.KEY_MASTERKEYINDEX,"03000021":i.PARAMS_KEYS.KEY_RESERVE_LABEL,"03000006":i.PARAMS_KEYS.KEY_SUPER_PWD,"03000004":i.PARAMS_KEYS.KEY_CODE_TYPE,"02000001":i.PARAMS_KEYS.KEY_TRANS_CONTROLLER},this.template=[{legend:"测试参数设置",body:[{type:i.RowType.CELL1,body:[{description:"The description of Item",componentsType:i.ComponentsType.SELECT,key:"select1",select:{"下拉1的选项1":"值1","下拉1的选项2":"值2"},defaultValue:"值1"}]},{type:i.RowType.CELL2,body:[{description:"The description of Item",componentsType:i.ComponentsType.SELECT,key:"select2",select:{"下拉2的选项1":"值_1","下拉2的选项2":"值_2"},defaultValue:"值_2"},{description:"The description of Item",componentsType:i.ComponentsType.RADIOBUTTON,key:"radiobutton1",select:{"单选1":"值_1","单选2":"值_2"},defaultValue:"值_1"}]},{type:i.RowType.CELL2,body:[{description:"The description of Item",componentsType:i.ComponentsType.SWITCH,key:"switch",defaultValue:"true"},{description:"The description of Item",componentsType:i.ComponentsType.TEXTINPUT,key:"input",defaultValue:"测试输入框"}]},{type:i.RowType.CELL2,body:[{description:"点击按钮进行XXX",componentsType:i.ComponentsType.BUTTON,key:"test-btn",defaultValue:"按钮文字",fnClick:function(){alert("Click function")}}]}]}];var o="t_config";this.isInit=!1;var s=function(){};this.init=function(e,a){this.isInit?a():(this.isInit=!0,this.tableSchemas=n.defineTables([{name:o,schema:{key:"TEXT",value:"TEXT",cre_time:"DATE",upd_time:"DATE"}}]),n.schemaSync(),s=this.tableSchemas[o],t.isNull(e)?a():i.initTSSParams(e,a))},this.initTSSParams=function(n,o){console.log("开始初始化TSS参数！"),e.ajax({url:n,dataType:"json",success:function(e){return console.log("获得TSS参数："+JSON.stringify(e)),t.isNull(e)?void console.log("tss参数初始化失败！"):void i.getConfigParam(i.PARAMS_KEYS.KEY_TSSPARAMS_VERSION,function(n){var s=!1;if(t.isNull(n))console.log("新增tss参数控制，将更新参数列表！"),i.setConfigParam(i.PARAMS_KEYS.KEY_TSSPARAMS_VERSION,e.VERSION),s=!0;else{var r=n.value;r<e.VERSION?(console.log("参数版本更新["+r+","+e.VERSION+"]，将更新参数列表！"),i.setConfigParam(i.PARAMS_KEYS.KEY_TSSPARAMS_VERSION,e.VERSION),s=!0):console.log("参数版未本更新["+r+","+e.VERSION+"]！")}s&&(i.setConfigParam(i.PARAMS_KEYS.KEY_TSSPARAMS_VERSION,e.VERSION),i.setConfigParam(i.PARAMS_KEYS.KEY_BUSINESSID,e.BUSINESSID),e.PARAMS.forEach(function(e){var n=i.TSS_PARAMS_TO_CONFIG_MAPPING[e.tag];t.isNull(n)||(console.log("设置参数["+n+"]:"+e.value),i.setConfigParam(n,e.value)),"03000002"===e&&(console.log("设置交易批次号:["+e.value+"]"),a.setProperty(a.setProperty(a.PROKEY_CONST.PROKEY_BATCH_ID),e.value))})),o()})},error:function(e){console.log("tss参数初始化失败！"+e.message),o()}})},this.setConfigParams=function(e){for(var t in e)e[t]=e[t].replace(/\s/g,""),i.setConfigParam(t,e[t]),"voucherNo"==t&&(a.setVoucherNo(e[t]),console.info("设置交易流水号:"+e[t])),"batchNo"==t&&(a.setProperty(a.PROKEY_CONST.PROKEY_BATCH_ID,e[t]),console.info("设置交易批次号:"+e[t]))},this.setConfigParam=function(e,a){n.inTransaction(function(){s.findBy("key",e,function(i){if(t.isNull(i)){var o=new s({key:e,value:a,cre_time:new Date});n.saveOrUpdate(o)}else i.value=a,i.upd_time=new Date,n.saveOrUpdate(o)})})},this.getConfigParam=function(e,t){n.inTransaction(function(){s.findBy("key",e,function(e){t(e)})})},this.getConfigParams=function(e){n.inTransaction(function(){var t=s.all();t.list(e)})},this.selectUiCreater=function(t,n){var a=t;a.append("<h5>"+n.description+"</h5>");var i=e('<div class="input-control select full-size"><select name="'+n.key+'" ></select></div>'),o=n.select,s=n.defaultValue?n.defaultValue:"";for(key in o){var r=e('<option value="'+o[key]+'">'+key+"</option>");o[key]==s&&r.prop("selected",!0),i.find("select").append(r)}return i.appendTo(a),a},this.radiobuttonUiCreater=function(t,n){var a=t;a.append("<h5>"+n.description+"</h5>");var i=n.select,o=n.defaultValue?n.defaultValue:"";for(key in i){var s=e('<label class="input-control radio"><input type="radio" value="'+i[key]+'" name="'+n.key+'"><span class="check"></span><span class="caption"></span></label>');i[key]==o&&s.find("input").prop("checked",!0),s.find(".caption").text(key),a.append(s)}return a},this.textinputUiCreater=function(n,a){var i=n;i.append("<h5>"+a.description+"</h5>");var o=a.defaultValue?a.defaultValue:"";this.getConfigParam(a.key,function(e){o=t.isNull(e)||t.isNull(e.value)?a.defaultValue:e.value});var s=e('<div class="input-control text full-size"><input type="text" name="'+a.key+'" maxlength="'+a.maxlength+'"></div>');return s.find("input").val(o),i.append(s),i},this.switchUiCreater=function(n,a){var i=n;i.append("<h5>"+a.description+"</h5>");var o="false";t.isNull(a.defaultValue)||"true"!=a.defaultValue||(o="true");var s=e('<label class="switch"><input type="checkbox" name="'+a.key+'"><span class="check"></span></label>');return"true"==o&&s.find("input").prop("checked",!0),i.append(s),i},this.buttonUiCreater=function(t,n){var a=t;a.append("<h5>"+n.description+"</h5>");var i=n,o=n.key,s=i.fnClick,r=e('<button id="'+o+'">'+n.defaultValue+"</button>");return e("body").undelegate("#"+o,"click").delegate("#"+o,"click",function(){s()}),a.append(r),a},this.passwordinputUiCreater=function(n,a){var i=n;i.append("<h5>"+a.description+"</h5>");var o=a.defaultValue?a.defaultValue:"";this.getConfigParam(a.key,function(e){o=t.isNull(e)||t.isNull(e.value)?a.defaultValue:e.value});var s=e('<div class="input-control text full-size"><input type="password" name="'+a.key+'"></div>');return s.find("input").val(o),i.append(s),i},this.gridCreater=function(t){for(var n=e('<div class="grid"></div>'),a=t,i=0;i<a.length;i++){for(var o=a[i].type,s=e('<div class="'+o+'"></div>'),r=a[i].body,l=0;l<r.length;l++){var p=r[l],c=e('<div class="cell"></div>');p.componentsType==this.ComponentsType.SELECT?c=this.selectUiCreater(c,p):p.componentsType==this.ComponentsType.RADIOBUTTON?c=this.radiobuttonUiCreater(c,p):p.componentsType==this.ComponentsType.TEXTINPUT?c=this.textinputUiCreater(c,p):p.componentsType==this.ComponentsType.SWITCH?c=this.switchUiCreater(c,p):p.componentsType==this.ComponentsType.BUTTON?c=this.buttonUiCreater(c,p):p.componentsType==this.ComponentsType.PASSWORDINPUT&&(c=this.passwordinputUiCreater(c,p)),s.append(c)}n.append(s)}return n},this.tabsCreater=function(t){for(var n=e('<div class="tabcontrol2" data-role="tabControl"></div>'),a=e('<ul class="tabs"></ul>'),i=e('<div class="frames"></div>'),o=t,s=0;s<o.length;s++){var r=e('<li class="autoCreated"><a href="#frame_'+s+'">'+o[s].legend+"</a></li>"),l=e('<div class="frame autoCreated" id="frame_'+s+'"></div>'),p=e('<div class="button-box"><button class="button primary save">保存</button><button class="button danger exit">退出</button></div>');a.append(r),l.append(this.gridCreater(o[s].body)),l.append(p),i.append(l)}return n.append(a).append(i),n},this.accordionCreater=function(t){for(var n=e('<div class="accordion" data-role="accordion" data-close-any="true"></div>'),a=t,i=0;i<a.length;i++){var o=e('<div class="button-box"><button class="button primary save">保存</button><button class="button danger exit">退出</button></div>'),s=e('<div class="frame"><div class="heading">'+a[i].legend+"</div></div>"),r=e('<div class="content"></div>');r.append(this.gridCreater(a[i].body)),r.append(o),window.console.log(r.html()),s.append(r),n.append(s)}return n},this.getFormParams=function(){for(var t={},n=e(":text, select, :radio:checked"),a=0;a<n.length;a++){var i=e(n[a]).attr("name"),o=e(n[a]).val().trim();t[i]=o}for(var s=e(".switch :checkbox"),a=0;a<s.length;a++){var i=e(s[a]).attr("name"),o=e(s[a]).is(":checked");t[i]=o}return t},this.setTempletWithList=function(e){var n=this;if(!t.isNull(e)){v=e;for(var a={},i=0;i<v.length;i++)a[v[i].key]=v[i].value;for(var o=n.template,i=0;i<o.length;i++)for(var s=o[i].body,r=0;r<s.length;r++)for(var l=s[r].body,p=0;p<l.length;p++){var c=l[p].key;a[c]&&(l[p].defaultValue=a[c])}n.template=o}},this.refreshTemplateWithDB=function(e){var t=(new Array,this),n=e;null==n?this.getConfigParams(function(e){t.setTempletWithList(e)}):(window.console.log("有值直接更新@@@@@@@@@@@@@@@"),t.setTempletWithList(n))}};define(["jquery","utils","dbManager","translogManager"],function(t,n,a,i){return new e(t,n,a,i)})}();