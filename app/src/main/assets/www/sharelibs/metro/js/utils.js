!function(){var Utils=function(gbkcoder){var utils=this;this.batchId="",this.isNull=function(t){return"undefined"==typeof t||null==t},this.arrayContains=function(t,r){if(!utils.isArray(t))return!1;for(var e=0;e<t.length;e++)if(t[e]===r)return!0;return!1},this.isArray=function(t){return"[object Array]"==Object.prototype.toString.call(t)},this.isFunction=function(t){return"function"==typeof t},this.notNullSetting=function(t,r,e){utils.isNull(t[e])||(r[e]=t[e])},this._getDate=function(){var t=new Date,r=t.getFullYear(),e=t.getMonth()+1>=10?t.getMonth()+1:"0"+(t.getMonth()+1),i=t.getDate()>=10?t.getDate():"0"+t.getDate();return r+""+e+i},this._getTime=function(){var t=new Date,r=t.getHours()>=10?t.getHours():"0"+t.getHours(),e=t.getMinutes()>=10?t.getMinutes():"0"+t.getMinutes(),i=t.getSeconds()>=10?t.getSeconds():"0"+t.getSeconds();return r+""+e+i},this.getLoginState=function(t){if(void 0==window.system.getLoginState)return void t();var r=window.system.getLoginState();1==r?t():0==r?setTimeout(function(){utils.getLoginState(t)},100):(alert("登录异常，稍后退出业务！"),setTimeout(function(){window.system.finish()},1e3))},this.formatDate=function(t,r){r||(r=new Date),"string"==typeof r&&(r=""==r?new Date:new Date(r.replace(/-/g,"/")));var e=function(t){var r=100+t;return r.toString().substring(1)},i={regeExp:/(yyyy|M+|d+|h+|m+|s+|ee+|ws?|p)/g,months:["January","February","March","April","May","June","July","August","September","October","November","December"],weeks:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},n=function(t){return t<12?"AM":"PM"},s={yyyy:r.getFullYear(),MM:e(r.getMonth()+1),dd:e(r.getDate()),hh:e(r.getHours()),mm:e(r.getMinutes()),ss:e(r.getSeconds()),ee:i.months[r.getMonth()],ws:i.weeks[r.getDay()],M:r.getMonth()+1,d:r.getDate(),h:r.getHours(),m:r.getMinutes(),s:r.getSeconds(),p:n(r.getHours())};return t.replace(i.regeExp,function(){return s[arguments[0]]})};var ISOUtils=function(){var uposBuffer=upos.require("buffer").Buffer;this.TLVMsg=function(t,r){var e=function(t){if(t%2!=0)throw new Error("不支持的长度!",t)};if(0!=arguments.length){if(utils.isNull(t))throw new Error("tag不可为空");if("string"==typeof t)this.tag=parseInt(t,16);else{if("number"!=typeof t)throw new Error("不支持的tag类型:"+typeof t);this.tag=t}if(utils.isArray(r))this.value=isoutils.binaryarrayToHexstr(r);else if(ArrayBuffer.prototype.isPrototypeOf(r))this.value=isoutils.arrayBufferToHexstr(r);else{if("string"!=typeof r)throw new Error("不支持的value类型:"+r);this.value=r}e(this.value.length)}this.toLengthStr=function(){var t=this.value.length;if(e(t),t/=2,t<=127)return isoutils.oneByteIntToHex(t);for(var r=t,i="",n=0;0!=r;r>>=8,n++)i=isoutils.oneByteIntToHex(255&r)+i;var s=128+n;return i=isoutils.oneByteIntToHex(s)+i},this.getValue=function(){return this.value},this.getTag=function(){return this.tag},this.pack=function(){return isoutils.intToHex(this.tag)+this.toLengthStr()+this.value},this.unpack=function(t,r){if(utils.isArray(t))t=isoutils.binaryarrayToHexstr(t);else if(ArrayBuffer.prototype.isPrototypeOf(t))t=isoutils.arrayBufferToHexstr(t);else if("string"!=typeof t)throw new Error("不支持的输入类型:"+t);var e=t.substring(r,r+2);r+=2;var i=255&parseInt(e,16);if(31===(31&i))do{var e=t.substring(r,r+2);r+=2;var n=255&parseInt(e,16);i=n+(i<<8)}while(128===(128&n));this.tag=i;var e=t.substring(r,r+2);r+=2;var s=parseInt(e,16);if(128===(128&s)){var o=127&s;s=0;for(var u=0;u<o;u++){var e=t.substring(r,r+2);r+=2,s=(255&parseInt(e,16))+(s<<8)}}return this.value=t.substring(r,r+2*s),r+=2*s},this.toJSON=function(){return"{0x"+isoutils.intToHex(this.tag)+":"+this.value+"}"}},this.TLVMsgPackager=function(){this.tlvmsgs={};var t=function(t,r){var e=t.tag.toString(16);if(utils.isNull(r[e]))r[e]=[];else if(!utils.isArray(r[e]))if("string"==typeof r[e]){var i=new isoutils.TLVMsg(e,r[e]);r[e]=[],r[e].push(i)}else{if(!isoutils.TLVMsg.prototype.isPrototypeOf(r[e]))throw new Error("不支持的原始TLV类型!"+JSON.stringify(r[e]));var i=r[e];r[e]=[],r[e].push(i)}r[e].push(t)};this.unpack=function(r){if(utils.isArray(r))r=isoutils.binaryarrayToHexstr(r);else if(ArrayBuffer.prototype.isPrototypeOf(r))r=isoutils.arrayBufferToHexstr(r);else if("string"!=typeof r)throw new Error("不支持的输入类型:"+r);for(var e=0;e<r.length;){var i=new isoutils.TLVMsg;e=i.unpack(r,e),t(i,this.tlvmsgs)}},this.pack=function(){var t="";for(var r in this.tlvmsgs)if(utils.isArray(this.tlvmsgs[r]))this.tlvmsgs[r].forEach(function(r){t+=r.pack()});else if(isoutils.TLVMsg.prototype.isPrototypeOf(this.tlvmsgs[r]))t+=this.tlvmsgs[r].pack();else if("string"==typeof this.tlvmsgs[r]){var e=new isoutils.TLVMsg(r,this.tlvmsgs[r]);t+=e.pack()}return t},this.getTlvMsg=function(t){if("string"==typeof t);else{if("number"!=typeof t)throw new Error("不支持的tag类型:"+typeof t);t=t.toString(16)}return this.tlvmsgs[t]},this.getValue=function(t){var r=this.getTlvMsg(t);return JSON.stringify(r),"string"==typeof r?r:utils.isArray(r)?r[0].getValue():isoutils.TLVMsg.prototype.isPrototypeOf(r)?r.getValue():void 0},this.append=function(r,e){var i;if(2==arguments.length)i=new isoutils.TLVMsg(r,e);else{if(1!=arguments.length)throw new Error("非法的参数！");if(!isoutils.TLVMsg.prototype.isPrototypeOf(r))throw new Error("非法的参数！");i=r}t(i,this.tlvmsgs)},this.appendGBKString=function(t,r){r=isoutils.stringToGbkHexstr(r),this.append(t,r)},this.appendASCII=function(t,r){r=isoutils.encodeAsc(r),this.append(t,r)},this.setTlvMsg=function(t,r){if(!isoutils.TLVMsg.prototype.isPrototypeOf(r)||!utils.isArray(r)||"string"==typeof r)throw new Error("非法的参数！");return this.tlvmsgs[t]=r},this.remove=function(t){if("string"==typeof t)t=parseInt(t,16);else if("number"!=typeof t)throw new Error("不支持的tag类型:"+typeof t);delete this.tlvmsgs[t]},this.toJSON=function(){var t="{";for(var r in this.tlvmsgs)t+="0x"+isoutils.intToHex(r)+":"+JSON.stringify(this.tlvmsgs[r])+",";return t+="}"}},this.GBKHexstrToString=function(t){if(t.length%2!==0)throw new Error("错误的输入:"+t);for(var r="",e=0;e<t.length;){var i=t.substring(e,e+2);if(e+=2,i.charAt(0)<"8")r+=String.fromCharCode(parseInt(i,16));else{var n=t.substring(e,e+2);e+=2,i+=n,r+=String.fromCharCode(gbkcoder.gbkToUnicodeMapping[parseInt(i,16)])}}return r},this.stringToGbkHexstr=function(t){for(var r="",e=0;e<t.length;e++){var i=65535&t.charCodeAt(e);r+=i<=255?isoutils.intToHex(i):isoutils.intToHex(gbkcoder.unicodeToGBKMapping[i])}return r},this.bitSet=function(t,r,e){if(r<0)return t;var i=parseInt(r/4),n=r%4;if(i>=t.length)throw new Error("超出长度限制:"+i);var s=t.charAt(i),o=Math.pow(2,3-n);return s=utils.isNull(e)||e?(o|parseInt(s,16)).toString(16):(~o&parseInt(s,16)).toString(16),t=t.substring(0,i)+s+t.substring(i+1).toUpperCase()},this.bitsSet=function(t,r,e){return utils.isArray(r)?r.length<=0?t:(r.forEach(function(r){t=utils.bitSet(t,r,e)}),t):t},this.insertInto=function(t,r,e){if(t.length<=e)throw new Error("超出长度限制:",e);return t.substring(0,e)+r+t.substring(e)},this.paddingLeft=function(t,r,e){for(;t.length<r;)t=e+t;return t},this.paddingRight=function(t,r,e){for(;t.length<r;)t+=e;return t},this.binarystrToHexstr=function(t){for(var r="",e=0;e<t.length;e++){var i=255&t.charCodeAt(e);r+=(i>>4&15).toString(16),r+=(15&i).toString(16)}return r},this.oneByteIntToHex=function(t){var r="";return t=parseInt(t),r+=(t>>4&15).toString(16),r+=(15&t).toString(16),r.toUpperCase()},this.intToHex=function(t){for(var r="";0!=t;t>>=8)r=isoutils.oneByteIntToHex(255&t)+r;return r.toUpperCase()},this.binaryarrayToHexstr=function(t){var r="";return utils.isNull(t)?r:utils.isArray(t)?(t.forEach(function(t){r+=this.oneByteIntToHex(t)}),r.toUpperCase()):r},this.arrayBufferToHexstr=function(t){var r="";if(utils.isNull(t))return r;if(!ArrayBuffer.prototype.isPrototypeOf(t))return console.error("err input type!not ArrayBuffer:"+t),r;for(var e=new Uint8Array(t),i=0;i<e.byteLength;i++)r+=this.oneByteIntToHex(e[i]);return r},this.uposBufferToHexstr=function(t){return utils.isNull(t)?"":uposBuffer.prototype.isPrototypeOf(t)?(console.error("err input type!not uposBuffer!"),""):isoutils.arrayBufferToHexstr(t.toArrayBuffer())},this.hexstrToUPosBuffer=function(t){return utils.isNull(t)?null:new uposBuffer(isoutils.hexstrToArray(t))},this.hexstrToArray=function(t){if(t.length%2!=0)throw new Error("not support length:"+t.length);for(var r=new Array,e=0,i=0;i<t.length;){var n=t.substring(i,i+1),s=(255&parseInt(n,16))<<4;i++,n=t.substring(i,i+1);var o=255&parseInt(n,16);r[e]=s+o,e++,i++}return r},this.binaryarrayToBcdHexstr=function(input){var output="";return utils.isNull(input)?output:utils.isArray(input)?(eval("output = String.fromCharCode("+input.toString()+");"),output):output},this.hexstrToBcdHexstr=function(t){var r="";if(utils.isNull(t))return r;var e=isoutils.hexstrToArray(t);return isoutils.binaryarrayToBcdHexstr(e)},this.encodeAsc=function(t){for(var r,e="",i=0;i<t.length;i++)r=t.charCodeAt(i).toString(16).toUpperCase(),e+=1===r.length?"0"+r:r;return e.trim()},this.decodeAsc=function(t){var r,e,i=[];if(!/[0-9a-fA-F]/m.test(t))throw new Error("Wrong Format!");if(t.length%2)throw new Error("Length not times to 2");for(var n=0;n<t.length/2;n++)e=t.substr(2*n,2),r=parseInt(e,16),i.push(r);return i=String.fromCharCode.apply(null,i)}};this.isoutils=new ISOUtils;var isoutils=this.isoutils,TransUtils=function(){this.calculateMac=function(t,r,e){var i=upos.require,n=(i("buffer").Buffer,i("hermes"),i("ums.api")),s={};if(e)for(var o in e)e.hasOwnProperty(o)&&(s[o]=e[o]);try{var u=n.dev.pinPad;if(!u.PinPad.prototype.isPrototypeOf(t))throw new Error("非法的传入参数类型[PinPad]："+JSON.stringify(t));var a=new u.Key({type:n.dev.pinPad.KeyType.MAC});t.open(),console.log("用于计算mac数据："+r);var f=isoutils.hexstrToUPosBuffer(r),l=t.calculateMac(f,a,s),g=isoutils.uposBufferToHexstr(l);return console.log("x919计算结果："+g),g}catch(h){window.console.log("fail"),window.console.log("提示信息:"+h.code+" "+h.message)}},this.MacGetError=function(t){switch(t){case 0:return this.SUCCESS;case 139:return this.PARAM_ERR;case 1:return this.ERROR;case 141:return this.DEVICE_NOT_AVAILABLE;default:return this.ERROR}},this.isChipCard=function(t){t=isoutils.hexstrToBcdHexstr(t);var r=t.toString("utf8",0,t.length),e=r.indexOf("=");return e<=0&&(e=r.indexOf("D")),e>=0&&("2"==t[e+5]||"6"==t[e+5])},this.getCardNumber=function(t,r){if(null!==t&&t.length>0){var e=t.toString("utf8",0,t.length),i=e.indexOf("=");return i<13||i>19?null:e.substring(0,i)}if(null!==r&&r.length>0){var e=r.toString("utf8",0,r.length),i=e.indexOf("=");return i<15||i>21?null:e.substring(2,i)}return null},this.maskCard=function(t){var r="";r=t.slice(0,6);for(var e=6;e<t.length-4;e++)r+="*";return r+=t.slice(-4)},this.parsePosEntryMode=function(t){if("string"!=typeof t)throw new Error("非法的输入类型！"+typeof t);if(3!=t.length)throw new Error("非法的服务点输入方式码!");var r={};return r.cardInputType=t.charAt(1),r.hasPininput="1"==t.charAt(2),r.isMagCard=function(){return"2"==this.cardInputType},r.isICCard=function(){return"5"==this.cardInputType},r.isHandle=function(){return"1"==this.cardInputType},r.isRFCard=function(){return"7"==this.cardInputType},r},this.parseBalance=function(t){if("string"!=typeof t)throw new Error("非法的输入类型！"+typeof t);return 20!=t.length?{}:{accountType:t.substring(0,2),amountType:t.substring(2,4),currency:t.substring(4,7),amountSign:t.substring(7,8),amount:t.substring(8,20)}},this.packupField48=function(t,r){var e=new isoutils.TLVMsgPackager;for(var i in t)e.appendASCII(i,t[i]);var n=isoutils.decodeAsc(e.pack()),s=isoutils.paddingLeft(n.length+"",3,"0"),o=r+s+n+"#";return isoutils.encodeAsc(o)},this.unpackField48=function(t){var r=t.substring(150,t.length-2),e=new isoutils.TLVMsgPackager;e.unpack(r);var i={};for(var n in e.tlvmsgs){var s=isoutils.decodeAsc(e.getValue(n));switch(n=parseInt(n,16)){case 48901:i.sysRefNo=s;break;case 16155:i.ChnName=s;break;case 16171:i.IdNum=s}}return i},this.packetScript55Field=function(){var t,r=upos.require("ums.api"),e="",i={"9F33":!0,95:!0,"9F37":!0,"9F1E":!0,"9F10":!0,"9F26":!0,"9F36":!0,DF31:!0,82:!0,"9F1A":!0,"9A":!0};for(var n in i){t=null;var s=i[n],o=r.util.encoding.hexStringToBuffer(n);console.log("emv内核读取key:"+n),s&&(console.log("begin  getTlv:"),t=r.pay.emv.getTlv(o,r.pay.emv.DataSource.KERNEL)),t?(console.log("值："+utils.transutils.addTLVBuffer(n,t)),e+=utils.transutils.addTLVBuffer(n,t)):s&&console.log("55域tlv标签:"+n+"的值不能为null")}return{F55:e}},this.addTLVBuffer=function(t,r){var e,i=upos.require("ums.api"),n=new i.iso8583.tlv.TLV(parseInt(t,16),r),s=n.encode(e);return i.util.encoding.bufferToHexString(s).toUpperCase()},this.praseTo12=function(t){function r(t,r){var e=0,i=t.toString(),n=r.toString();try{e+=i.split(".")[1].length}catch(s){}try{e+=n.split(".")[1].length}catch(s){}return Number(i.replace(".",""))*Number(n.replace(".",""))/Math.pow(10,e)}for(var e=r(t,100),i=12-e.toString().length,n=0;n<i;n++)e="0"+e;return e},this.parseTo2=function(t){var t=Number(t),r=t%100;return 0==r?t/100+".00":r%10==0?t/100+"0":Number(t)/100},this.div63AfterComm=function(t){if(void 0==t||t.length<=0)return"";var r=utils.isoutils.stringToGbkHexstr(t),e=0,i=0,n="",s=r.length;if(s<6)return"";e+=6;var o="";if(s>6){i=s-6>40?40:s-6,n=r.substr(e,i);try{o=utils.isoutils.GBKHexstrToString(n).trim()}catch(u){window.console.log("转换字符失败：["+n+"]")}}e+=40;var a="";if(s>46){i=s-46>40?40:s-46,n=r.substr(e,i);try{a=utils.isoutils.GBKHexstrToString(n).trim()}catch(u){window.console.log("转换字符失败：["+n+"]")}}e+=40;var f="";if(s>86){i=s-86>40?40:s-86,n=r.substr(e,i);try{f=utils.isoutils.GBKHexstrToString(n).trim()}catch(u){window.console.log("转换字符失败：["+n+"]")}}var l="";return""==o&&""==a&&""==f||(l+="附加信息(Host):\n",""!=o&&(l+=o),""!=a&&(l+=a),""!=f&&(l+=f),l+="\n"),l}};this.transutils=new TransUtils};define(["gbkcoder"],function(t){return new Utils(t)})}();